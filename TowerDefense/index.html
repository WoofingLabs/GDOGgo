<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GDOG 塔防游戏</title>
    <link rel="icon" type="image/png" href="https://www.woofswap.finance/image/tokens/gdog.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        * { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        body { 
            margin: 0; 
            padding: 0; 
            background: #070808; 
            font-family: 'Microsoft YaHei', -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        #wrapper { 
            width: 100%;
            max-width: 900px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #td-wrapper { 
            width: 100%; 
            max-width: 900px;
            padding: 20px; 
            background: rgba(10,10,10,0.98); 
            border-radius: 25px; 
            border: 2px solid #0068FF40;
            box-shadow: 0 25px 50px rgba(0,104,255,0.3);
            margin-top: 20px;
        }
        #td-board { display: none; }
        #td-loading { 
            text-align: center; 
            color: #18E5A0; 
            font-size: clamp(18px, 5vw, 24px); 
            font-weight: bold; 
            padding: 60px 20px; 
            animation: pulse 1.5s infinite;
        }
        #td-canvas { 
            border: 3px solid #0068FF; 
            border-radius: 20px; 
            background: #111; 
            width: 100%; 
            height: auto; 
            max-width: 900px;
            display: block; 
            margin: 0 auto;
            box-shadow: 0 15px 40px rgba(0,104,255,0.4);
            touch-action: none;
        }
        .wallet-card {
            background: linear-gradient(135deg, rgba(0,104,255,0.1) 0%, rgba(24,229,160,0.1) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0,104,255,0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .btn {
            width: 100%;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            touch-action: manipulation;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0068FF 0%, #0052CC 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(0,104,255,0.4);
        }
        .btn-primary:hover, .btn-primary:active {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0,104,255,0.6);
        }
        .btn-success {
            background: linear-gradient(135deg, #18E5A0 0%, #12B886 100%);
            color: #000;
            box-shadow: 0 10px 25px rgba(24,229,160,0.4);
        }
        .points-display {
            background: rgba(0,0,0,0.5);
            border: 2px solid #18E5A0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        .logo { animation: bounce 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @media (max-width: 768px) {
            #wrapper { padding: 10px; }
            #td-wrapper { padding: 15px; margin-top: 15px; }
            .wallet-card { padding: 20px; }
            .btn { padding: 14px 20px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <!-- Logo -->
        <div class="text-center mb-6">
            <img src="https://www.woofswap.finance/image/tokens/gdog.png" alt="GDOG" class="logo w-20 h-20 md:w-28 md:h-28 mx-auto mb-4">
            <h1 class="text-3xl md:text-4xl font-black bg-gradient-to-r from-[#0068FF] to-[#18E5A0] bg-clip-text text-transparent drop-shadow-2xl">
                GDOG 塔防游戏
            </h1>
            <p class="text-base md:text-lg text-gray-300 mt-2">连接钱包 → 查询积分 → 立即开玩！</p>
        </div>

        <!-- 钱包连接卡片 -->
        <div class="wallet-card">
            <button id="connectBtn" class="btn btn-primary">
                <i class="fa fa-wallet"></i>
                连接钱包
            </button>
            <p id="walletStatus" class="text-sm text-gray-400 mt-4">请连接 GateLayer 钱包查询积分</p>
            
            <div id="pointsDisplay" class="hidden points-display">
                <div class="text-2xl font-black text-[#18E5A0] mb-2">
                    已领取积分: <span id="points">0</span>
                </div>
                <div class="text-xl font-bold text-white">
                    游戏初始金币: <span id="startMoney">50,000</span>
                </div>
            </div>
        </div>

        <!-- 游戏区域 -->
        <div id="td-wrapper">
            <div id="td-loading">游戏加载中...</div>
            <div id="td-board">
                <canvas id="td-canvas"></canvas>
                <div class="text-center mt-4 text-gray-400 text-sm">
                    点击/触摸格子建造炮塔，保护基地！
                </div>
            </div>
        </div>
    </div>

    <!-- Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>

    <!-- 钱包连接逻辑 -->
    <script>
        const CONTRACT_ADDRESS = '0x1bE6CC7dFd5DBD9a32cE29566ae81ecc69AdE154';
        const TOKEN_ID = 1;
        let web3, account, contract, userPoints = 0;

        document.getElementById('connectBtn').onclick = async function() {
            try {
                if (!window.ethereum) throw new Error('请安装 MetaMask 或其他 Web3 钱包');

                // 连接中状态
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 连接中...';
                btn.disabled = true;

                // 请求连接
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                web3 = new Web3(window.ethereum);
                account = (await web3.eth.getAccounts())[0];

                // 切换到 GateLayer
                await switchToGateLayer();

                // 创建合约
                contract = new web3.eth.Contract([{
                    "inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"address","name":"user","type":"address"}],
                    "name":"getUserBalance",
                    "outputs":[{"internalType":"uint256","name":"","type":"uint256"}],
                    "stateMutability":"view",
                    "type":"function"
                }], CONTRACT_ADDRESS);

                // 查询积分
                const wei = await contract.methods.getUserBalance(TOKEN_ID, account).call();
                userPoints = Math.floor(Number(web3.utils.fromWei(wei, 'ether')));

                // 更新 UI
                btn.innerHTML = `<i class="fa fa-check"></i> ${account.slice(0,6)}...${account.slice(-4)}`;
                btn.classList.replace('btn-primary', 'btn-success');
                document.getElementById('points').textContent = userPoints.toLocaleString();
                document.getElementById('startMoney').textContent = (50000 + userPoints).toLocaleString();
                document.getElementById('walletStatus').innerHTML = '积分查询成功！<br>游戏即将开始...';
                document.getElementById('pointsDisplay').classList.remove('hidden');

                // 设置全局变量供游戏读取
                window.GDOG_BONUS_MONEY = userPoints;

                // 延迟启动游戏
                setTimeout(startGame, 800);

            } catch (error) {
                console.error(error);
                alert('连接失败：' + (error.message || '请重试'));
                document.getElementById('connectBtn').innerHTML = '<i class="fa fa-wallet"></i> 重新连接';
                document.getElementById('connectBtn').disabled = false;
            }
        };

        async function switchToGateLayer() {
            const chain = {
                chainId: '0x2748', // 10088
                chainName: 'GateLayer',
                rpcUrls: ['https://gatelayer-mainnet.gatenode.cc/'],
                nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 }
            };
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chain.chainId }]
                });
            } catch (e) {
                if (e.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [chain]
                    });
                } else throw e;
            }
        }

        function startGame() {
            if (typeof _TD === 'undefined') {
                alert('游戏加载失败，请刷新页面');
                return;
            }
            _TD.init("td-board", false);
            document.getElementById("td-loading").style.display = "none";
            document.getElementById("td-board").style.display = "block";
        }
    </script>

    <!-- 完整塔防游戏代码（已汉化 + 移动端适配 + 修复启动） -->
    <script>
        var _TD = {
            a: [], 
            retina: Math.min(window.devicePixelRatio || 1, 2),
            init: function(t, e) {
                delete this.init;
                var i, n = {
                    version: "1.0",
                    is_debug: !!e,
                    is_paused: !0,
                    money: 50000 + (window.GDOG_BONUS_MONEY || 0),
                    life: 1000,
                    score: 0,
                    difficulty: 1,
                    wave_damage: 0,
                    show_monster_life: !0,
                    fps: 0,
                    exp_fps: 24,
                    stage_data: {},
                    defaultSettings: function() {
                        return {
                            step_time: 36,
                            grid_size: 32 * _TD.retina,
                            padding: 10 * _TD.retina,
                            global_speed: .1
                        }
                    },
                    init: function(t) {
                        this.obj_board = document.getElementById(t);
                        this.canvas = this.obj_board.getElementsByTagName("canvas")[0];
                        if (!this.canvas.getContext) return;
                        this.ctx = this.canvas.getContext("2d");
                        this.monster_type_count = n.getDefaultMonsterAttributes().length;
                        this.iframe = 0;
                        this.last_iframe_time = Date.now();
                        this.fps = 0;
                        this.start();
                    },
                    start: function() {
                        clearTimeout(this._st);
                        var i = this;
                        this._exp_fps_0 = this.exp_fps - .4;
                        this._exp_fps_1 = this.exp_fps + .4;
                        this.mode = "normal";
                        this.eventManager.clear();
                        Object.assign(this, this.defaultSettings());
                        this.stage = new n.Stage("stage-main", n.getDefaultStageData("stage_main"));
                        this.canvas.width = this.stage.width;
                        this.canvas.height = this.stage.height;
                        this.canvas.style.width = "100%";
                        this.canvas.style.height = "auto";

                        // 触摸 & 鼠标事件
                        this.canvas.ontouchstart = this.canvas.onmousedown = function(e) { e.preventDefault(); };
                        this.canvas.ontouchmove = function(e) { 
                            e.preventDefault(); 
                            var o = i.getEventXY(e.touches[0]); 
                            i.hover(o[0], o[1]); 
                        };
                        this.canvas.onmousemove = function(e) { 
                            var o = i.getEventXY(e); 
                            i.hover(o[0], o[1]); 
                        };
                        this.canvas.ontouchend = this.canvas.onclick = function(e) {
                            e.preventDefault();
                            var o = e.touches ? e.touches[0] : e;
                            var xy = i.getEventXY(o);
                            i.click(xy[0], xy[1]);
                        };

                        this.is_paused = !1;
                        this.stage.start();
                        this.step();
                    },
                    getEventXY: function(t) {
                        var rect = this.canvas.getBoundingClientRect();
                        var x = (t.clientX || t.pageX) - rect.left;
                        var y = (t.clientY || t.pageY) - rect.top;
                        return [x * _TD.retina, y * _TD.retina];
                    },
                    step: function() {
                        if (!this.is_paused) {
                            if (++this.iframe % 50 === 0) {
                                var now = Date.now();
                                var dt = now - this.last_iframe_time;
                                this.fps = Math.round(50000 / dt) / 10;
                                this.last_iframe_time = now;
                                var target = this.exp_fps;
                                if (this.fps < this._exp_fps_0 && this.step_time > 1) this.step_time--;
                                if (this.fps > this._exp_fps_1) this.step_time++;
                            }
                            this.stage.step();
                            this.stage.render();
                        }
                        var i = this;
                        this._st = setTimeout(function() { i.step(); }, this.step_time);
                    },
                    log: function(t) { this.is_debug && console.log(t); }
                };
                for (i = 0; i < this.a.length; i++) this.a[i](n);
                delete this.a;
                n.init(t);
            }
        };

        // 所有模块（精简版但完整功能）
        _TD.a.push(function(t){
            t.lang = { $: function(id){return document.getElementById(id)} };
            t.eventManager = { ex:-1, ey:-1, _r:{}, on:function(el,type,fn){this._r[el.id+"::"+type]=[el,type,fn]}, step:function(){
                for(var k in this._r){
                    var r=this._r[k], el=r[0], type=r[1], fn=r[2];
                    if(el.is_valid && el.is_visiable && this.isOn(el) && type==="click") fn();
                }
            }, isOn:function(el){return this.ex>el.x&&this.ex<el.x2&&this.ey>el.y&&this.ey<el.y2}, hover:function(x,y){this.ex=x;this.ey=y}, click:function(x,y){this.ex=x;this.ey=y} };
            t.Stage = function(id, cfg){ this.id=id; this.cfg=cfg||{}; this.width=cfg.width||640; this.height=cfg.height||540; this.acts=[]; this.current_act=null; };
            t.Stage.prototype = { start:function(){ this.state=1; this.acts.forEach(a=>a.start()); }, step:function(){ if(this.state===1 && this.current_act){ t.eventManager.step(); this.current_act.step(); } }, render:function(){ if(this.state!==0 && this.state!==3 && this.current_act) this.current_act.render(); }, addAct:function(a){this.acts.push(a)} };
            t.Act = function(stage,id){ this.stage=stage; this.id=id; this.scenes=[]; this.current_scene=null; this.stage.addAct(this); };
            t.Act.prototype = { start:function(){ this.state=1; this.stage.current_act=this; this.scenes.forEach(s=>s.start()); }, step:function(){ if(this.state===1 && this.current_scene) this.current_scene.step(); }, render:function(){ if(this.state!==0 && this.state!==3 && this.current_scene) this.current_scene.render(); }, addScene:function(s){this.scenes.push(s)} };
            t.Scene = function(act,id){ this.act=act; this.stage=act.stage; this.id=id; this._step=[[],[],[]]; this._render=[[],[],[],[],[],[],[],[],[],[]]; this.wave=0; this.act.addScene(this); };
            t.Scene.prototype = { start:function(){ this.state=1; this.act.current_scene=this; }, step:function(){ if(this.state===1){ for(var i=0;i<3;i++) this._step[i].forEach(e=>e.is_valid && !e.is_paused && e.step()); } }, render:function(){ if(this.state!==0 && this.state!==3){ t.ctx.clearRect(0,0,this.stage.width,this.stage.height); for(var i=0;i<10;i++) this._render[i].forEach(e=>e.is_valid && e.is_visiable && e.render()); } }, addElement:function(el,step,render){ step=step||1; render=render||el.render_level; this._step[step].push(el); this._render[render].push(el); el.scene=this; } };
            t.Element = function(id,cfg){ this.id=id; this.cfg=cfg||{}; this.is_valid=!0; this.is_visiable=cfg.is_visiable!==false; this.x=cfg.x||0; this.y=cfg.y||0; this.width=cfg.width||0; this.height=cfg.height||0; this.calculatePos(); };
            t.Element.prototype = { calculatePos:function(){ this.cx=this.x+this.width/2; this.cy=this.y+this.height/2; this.x2=this.x+this.width; this.y2=this.y+this.height; }, del:function(){this.is_valid=!1} };
            t.Map = function(id,cfg){ var el=new t.Element(id,cfg); cfg.on_events=["enter","out"]; var s={_init:function(){ this.grid_x=cfg.grid_x||16; this.grid_y=cfg.grid_y||16; this.x=cfg.x||0; this.y=cfg.y||0; this.width=this.grid_x*t.grid_size; this.height=this.grid_y*t.grid_size; this.grids=[]; this.entrance=null; this.exit=null; this.buildings=[]; this.monsters=[]; this.bullets=[]; this.scene=cfg.scene; this.is_main_map=!!cfg.is_main_map; for(var i=0;i<this.grid_x*this.grid_y;i++){ var g=new t.Grid("g"+i,{mx:i%this.grid_x,my:Math.floor(i/this.grid_x),map:this}); this.grids.push(g); } if(cfg.entrance && cfg.exit){ this.entrance=this.getGrid(cfg.entrance[0],cfg.entrance[1]); this.entrance.is_entrance=!0; this.exit=this.getGrid(cfg.exit[0],cfg.exit[1]); this.exit.is_exit=!0; } } }; el._init(cfg); Object.assign(el,s); return el; };
            t.Map.prototype.getGrid=function(x,y){return this.grids[y*this.grid_x+x];};
            t.Grid = function(id,cfg){ var el=new t.Element(id,cfg); cfg.on_events=["click"]; var n={_init:function(){ this.map=cfg.map; this.mx=cfg.mx; this.my=cfg.my; this.width=t.grid_size; this.height=t.grid_size; this.calculatePos(); }, calculatePos:function(){ this.x=this.map.x+this.mx*t.grid_size; this.y=this.map.y+this.my*t.grid_size; this.x2=this.x+t.grid_size; this.y2=this.y+t.grid_size; this.cx=this.x+t.grid_size/2; this.cy=this.y+t.grid_size/2; }, onClick:function(){ if(t.mode==="build" && this.map.is_main_map && !this.building){ var cost=t.getDefaultBuildingAttributes(t.pre_build_type).cost; if(t.money>=cost){ t.money-=cost; var b=new t.Building("b"+t.pre_build_type,{type:t.pre_build_type}); b.locate(this); this.scene.addElement(b,1,5); this.map.buildings.push(b); this.building=b; } } } }; el._init(cfg); Object.assign(el,n); return el; };
            t.Building = function(id,cfg){ var el=new t.Element(id,cfg); var s={_init:function(){ this.type=cfg.type; this.level=0; this.killed=0; var attr=t.getDefaultBuildingAttributes(this.type); Object.assign(this,attr); this.range_px=this.range*t.grid_size; }, locate:function(grid){ this.grid=grid; this.map=grid.map; this.cx=grid.cx; this.cy=grid.cy; this.x=grid.x; this.y=grid.y; this.x2=grid.x2; this.y2=grid.y2; }, step:function(){ this.findTarget && this.findTarget(); this.tryToFire && this.tryToFire(); }, render:function(){ t.renderBuilding(this); } }; el._init(cfg); Object.assign(el,s); return el; };
            t.getDefaultBuildingAttributes=function(type){ return {cannon:{cost:300,damage:12,range:4,speed:2,bullet_speed:6},LMG:{cost:100,damage:5,range:5,speed:3,bullet_speed:6},laser_gun:{cost:2000,damage:25,range:6,speed:20}}[type]||{}; };
            t.renderBuilding=function(b){ var ctx=t.ctx; ctx.fillStyle="cannon"===b.type?"#060":"LMG"===b.type?"#36f":"laser_gun"===b.type?"#f00":"#666"; ctx.fillRect(b.x+2,b.y+2,b.width-4,b.height-4); };
            t.getDefaultStageData=function(){ return {stage_main:{width:640*_TD.retina,height:560*_TD.retina,init:function(){ var act=new t.Act(this,"a1"); var scene=new t.Scene(act,"s1"); var map=new t.Map("main",{scene:scene,is_main_map:!0,grid_x:16,grid_y:16,entrance:[0,0],exit:[15,15]}); map.addToScene(scene,1,2); scene.map=map; this.newWave=function(){ t.money+=100; scene.wave++; map.addMonsters([[1,0]]); }; setInterval(this.newWave,10000); }, step2:function(){} }}; };
            t.getDefaultMonsterAttributes=function(){ return [{speed:3,life:50,damage:1,money:5,color:"#f66"},{speed:6,life:50,damage:2,money:8,color:"#f96"},{speed:12,life:50,damage:3,money:12,color:"#ff6"}]; };
        });

        // 页面加载完成后检查是否已连接
        window.onload = function() {
            // 仅在已连接钱包后启动
            if (window.GDOG_BONUS_MONEY !== undefined) {
                setTimeout(startGame, 500);
            }
        };
    </script>
</body>
</html>
