<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>GDOG - 每锁20万得1个球</title>
  <link rel="icon" type="image/png" href="https://www.woofswap.finance/image/tokens/gdog.png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#faf8ef;font-family:Arial;overflow:hidden;touch-action:manipulation}
    #app{text-align:center;padding:20px}
    button{background:#0068FF;color:#fff;border:none;padding:12px 24px;font-size:1.1em;border-radius:8px;cursor:pointer;margin:10px;transition:.3s}
    button:hover{background:#0050cc}
    button:disabled{background:#666;cursor:not-allowed}
    #status{margin:10px 0;color:#333}
    #gameContainer{max-width:720px;margin:0 auto}
    canvas{border:3px solid #000;display:block;margin:0 auto;max-width:100%;height:auto;background:#faf8ef}
    #downBtn{background:#18E5A0;margin-top:10px}
    #downBtn:hover{background:#12c589}
    #lockCard{background:#fff;color:#000;padding:16px;border-radius:12px;margin:15px auto;max-width:500px;box-shadow:0 4px 12px rgba(0,0,0,.1);font-weight:bold;line-height:1.6}
    #lockCard .highlight{color:#0068FF;font-size:1.3em}
  </style>
</head>
<body>
  <div id="app">
    <h1>GDOG 锁仓游戏</h1>
    <div id="connectSection">
      <button id="connectBtn">连接钱包</button>
      <div id="status">请连接钱包到 GateLayer 网络</div>
    </div>
    <div id="lockCard" style="display:none">
      <div>您已锁仓 <span id="lockedAmount" class="highlight">0</span> GDOG</div>
      <div>初始小球 <span id="extraBalls" class="highlight">+0</span> 个</div>
      <div style="font-size:.9em;margin-top:8px;color:#666">每锁定 20万 GDOG，游戏开局 +1 个球</div>
    </div>
    <div id="gameContainer" style="display:none">
      <canvas id="canvas" width="720" height="800"></canvas>
      <button id="downBtn" onclick="gameManager.downBalls()">球下落</button>
    </div>
  </div>

  <script src="https://unpkg.com/web3@1.10.4/dist/web3.min.js"></script>
  <script>
    window.addEventListener('load',()=>{const CONTRACT_ADDRESS='0x939Cf35295528870e504d81338D30B2C776849A0',LOCK_PER_BALL=200000,contractAbi=[{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getLockedBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}],chains={GateLayer:{chainId:10088,chainName:'Gate Layer',rpcUrl:'https://gatelayer-mainnet.gatenode.cc',blockExplorer:'https://gatescan.org/gatelayer',nativeCurrency:{name:'GT',symbol:'GT',decimals:18}}};let web3,account,airdropContract,extraBalls=0;async function initializeWeb3(){const b=document.getElementById('connectBtn'),s=document.getElementById('status');if(typeof Web3==='undefined'){s.textContent='Web3 未加载';return}if(!window.ethereum){s.textContent='请安装 MetaMask';return}b.disabled=!0;b.textContent='连接中...';s.textContent='请求授权...';try{web3=new Web3(window.ethereum);await window.ethereum.request({method:'eth_requestAccounts'});account=(await web3.eth.getAccounts())[0];s.textContent='切换网络...';await switchNetwork('GateLayer');airdropContract=new web3.eth.Contract(contractAbi,CONTRACT_ADDRESS);s.textContent='查询锁仓...';await updateLockInfo();document.getElementById('connectSection').style.display='none';document.getElementById('lockCard').style.display='block';document.getElementById('gameContainer').style.display='block';initGame();s.textContent='连接成功'}catch(e){s.textContent='连接失败: '+(e.message||'');b.disabled=!1;b.textContent='连接钱包'}}async function switchNetwork(c){const o=chains[c];try{await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:'0x'+o.chainId.toString(16)}]})}catch(e){if(e.code===4902)await window.ethereum.request({method:'wallet_addEthereumChain',params:[{chainId:'0x'+o.chainId.toString(16),chainName:o.chainName,rpcUrls:[o.rpcUrl],nativeCurrency:o.nativeCurrency,blockExplorerUrls:[o.blockExplorer]}]);else throw e}}async function updateLockInfo(){if(!airdropContract||!account)return;try{const w=await airdropContract.methods.getLockedBalance(account).call(),g=Number(web3.utils.fromWei(w,'ether')).toFixed(2);extraBalls=Math.floor(Number(g)/LOCK_PER_BALL);document.getElementById('lockedAmount').textContent=g;document.getElementById('extraBalls').textContent='+'+extraBalls}catch(e){document.getElementById('lockedAmount').textContent='查询失败';document.getElementById('extraBalls').textContent='+0'}}const GDOG_IMG=new Image();GDOG_IMG.src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png";const GT_IMG=new Image();GT_IMG.src="https://www.woofswap.finance/image/tokens/GT.png";function randomInt(...a){if(a.length===1)return Math.ceil(Math.random()*a[0]);const[s,e]=a;return Math.ceil(Math.random()*(e-s))+s}function random(...a){if(a.length===1)return Math.random()*a[0];const[s,e]=a;return Math.random()*(e-s)+s}const range=(n,m)=>arguments.length===1?Array.from({length:n},(_,i)=>i):Array.from({length:m-n+1},(_,i)=>i+n);function clamp(v,min,max){return Math.max(min,Math.min(max,v))}const delay=n=>new Promise(r=>setTimeout(r,n));class Vector{constructor(x=0,y=0){this.x=x;this.y=y}add(v){this.x+=v.x;this.y+=v.y}mult(n){this.x*=n;this.y*=n}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}copy(){return new Vector(this.x,this.y)}}Vector.mult=(v,n)=>new Vector(v.x*n,v.y*n);const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),width=710,height=880,uiOffsetY=80;canvas.width=width;canvas.height=height;function resizeCanvas(){const s=Math.min(window.innerWidth/720,1);canvas.style.width=720*s+'px';canvas.style.height=800*s+'px'}resizeCanvas();window.addEventListener('resize',resizeCanvas);function drawImageCentered(i,x,y,s){if(i.complete){ctx.save();ctx.beginPath();ctx.arc(x,y,s/2,0,Math.PI*2);ctx.clip();ctx.drawImage(i,x-s/2,y-s/2,s,s);ctx.restore()}else{ctx.save();ctx.beginPath();ctx.arc(x,y,s/2,0,Math.PI*2);ctx.lineWidth=3;ctx.fillStyle=i===GDOG_IMG?"#5ba7f4":"#3dd462";ctx.strokeStyle=ctx.fillStyle;ctx.fill();ctx.stroke();ctx.restore()}}function clear(){ctx.clearRect(0,0,width,height)}function shuffle(a){return a.sort(()=>Math.random()-0.5)}const POWER=0.3,Mouse={position:new Vector(0,0)};class Ball{constructor(m,x,y){this.position=new Vector(x,y);this.velocity=new Vector(0,0);this.acceleration=new Vector(0,0);this.mass=m;this.r=m*8;this.showDirection=!0}setOnStop(f){this.onStop=f}applyForce(f){const ff=Vector.div(f,this.mass);this.acceleration.add(ff)}update(){this.velocity.add(this.acceleration);this.position.add(this.velocity);this.acceleration.mult(0)}stop(){this.velocity=new Vector(0,0);this.showDirection=!0;this.onStop(this);this.downing=!1}down(){this.downing=!0;this.velocity=new Vector(0,30)}shoot(p){this.showDirection=!1;const f=this.calcBallVelocity(this.angle(p));this.applyForce(f)}calcBallVelocity(a){return new Vector(100*Math.cos(a)*POWER,100*Math.sin(a)*POWER)}angle(p){return Math.atan2(p.y-this.position.y,p.x-this.position.x)}display(){drawImageCentered(GDOG_IMG,this.position.x,this.position.y,this.r*2)}checkEdges(){if(this.position.x>width){this.position.x=width;this.velocity.x*=-1}else if(this.position.x<0){this.position.x=0;this.velocity.x*=-1}if(this.position.y>height-100){this.velocity.y*=-1;this.position.y=height-100;this.stop()}else if(this.position.y<100){this.velocity.y*=-1;this.position.y=100}}collideWith(b){if(this.downing)return!1;const{x,y}=this.position,r=this.r,cx=clamp(x,b.x,b.x+b.w),cy=clamp(y,b.y,b.y+b.h),dx=x-cx,dy=y-cy,d2=dx*dx+dy*dy;if(d2>=r*r)return!1;if(cy===b.y&&dx*dx<r*r){this.velocity.y*=-1;this.position.y=cy-r}else if(cy===b.y+b.h&&dx*dx<r*r){this.velocity.y*=-1;this.position.y=cy+r}else if(cx===b.x&&dy*dy<r*r){this.velocity.x*=-1;this.position.x=cx-r}else if(cx===b.x+b.w&&dy*dy<r*r){this.velocity.x*=-1;this.position.x=cx+r}return!0}collideWithBonusBall(bb){if(this.downing)return!1;const dx=this.position.x-bb.x,dy=this.position.y-bb.y,r=this.r;return 2*r>=Math.sqrt(dx*dx+dy*dy)}}class Brick{constructor(n,x,y){this.n=n;this.start=n;this.x=x*120;this.y=y*80+uiOffsetY;this.w=110;this.h=70}shouldMoveDown(s){return this.y<80*(s.level-this.start+1)+uiOffsetY}update(s){if(this.shouldMoveDown(s))this.y=Math.min(this.y+10,80*(s.level-this.start+1)+uiOffsetY)}color(l){const p=((l-this.n)/l)*30;return`hsl(${p},${100-p}%,63%)`}display(s){ctx.save();ctx.fillStyle=this.color(s.level);ctx.fillRect(this.x,this.y,this.w,this.h);ctx.stroke();ctx.restore();ctx.fillStyle="#000";ctx.font="20px Arial";ctx.fillText(this.n,this.x+this.w/2-8,this.y+this.h/2+5)}hit(){this.n--}get broken(){return this.n<=0}get hitBottom(){return this.y>=height-uiOffsetY-80}}function fillRect(x,y,w,h,c="#171717"){ctx.save();ctx.fillStyle=c;ctx.fillRect(x,y,w,h);ctx.stroke();ctx.restore()}function between(v,min,max){return min<=v&&v<=max}class BrickParticle{constructor(n,x,y){const i=n%5,j=~~(n/4);this.w=22;this.h=18;this.location=new Vector(x+i*this.w,y+j*this.h);this.acceleration=new Vector(0,0);this.velocity=new Vector(i>2?random(0,.5):i===2?random(-.5,.5):random(-.5,0),random(1,3));this.lifespan=255}update(){this.velocity.add(this.acceleration);this.location.add(this.velocity);this.lifespan-=4}display(){fillRect(this.location.x,this.location.y,22,18,`hsla(30,70%,63%,${this.lifespan/255})`)}run(){this.update();this.display()}get isDead(){return this.lifespan<0}}class BrickParticleSystem{constructor(x,y){this.origin=new Vector(x,y);this.particles=range(20).map(n=>new BrickParticle(n,x,y))}run(){this.particles.forEach(p=>p.run())}get isDead(){return!this.particles.length||this.particles[0].isDead}}class BrickParticleSystems{constructor(){this.systems=[]}addParticleSystem(...b){this.systems.push(...b.map(o=>new BrickParticleSystem(o.x,o.y)))}run(){this.systems=this.systems.filter(s=>!s.isDead);this.systems.forEach(s=>s.run())}}class BonusBall{constructor(n,x,y){this.start=n;this.r=16;this.x=x*120+56;this.y=y*80+36+uiOffsetY;this.hit=!1}moveDownLittle(s){this.y=Math.min(this.y+10,80*(s.level-this.start+1)+uiOffsetY+40)}update(s){this.hit?this.y=Math.min(this.y+50,height-100):this.moveDownLittle(s);if(this.hit&&this.y===height-100&&s.brickMoving){this.x<this.ballPos.x?this.x=Math.min(this.x+30,this.ballPos.x):this.x=Math.max(this.x-30,this.ballPos.x)}}display(){drawImageCentered(GT_IMG,this.x,this.y,this.r*2)}hitWithBall(){this.hit=!0}collideWith(b){const dx=b.position.x-this.x,dy=b.position.y-this.y,r=this.r;if(2*r>=Math.sqrt(dx*dx+dy*dy)){this.hit=!0}return!0}}class UI{constructor(){}display(s){ctx.beginPath();ctx.moveTo(0,uiOffsetY);ctx.lineTo(width,uiOffsetY);ctx.moveTo(0,height-uiOffsetY);ctx.lineTo(width,height-uiOffsetY);ctx.stroke();this.showBallCount(s);this.showScore(s)}showScore(s){ctx.fillStyle="#000";ctx.font="20px Arial";ctx.fillText(`当前关卡: ${s.level}`,30,uiOffsetY/2+7);ctx.fillText(`最高纪录: ${s.bestLevel}`,width-150,uiOffsetY/2+7)}showBallCount(s){!s.ballMoving&&ctx.fillText(`x${s.ballCount}`,s.ballPos.x-10,height-55)}gameOver(){fillRect(0,height/2-100,width,200,"rgba(0,0,0,.3)");ctx.font="40px Arial";ctx.fillStyle="#fff";ctx.fillText("游戏结束!",width/2-70,height/2+12);ctx.font="20px Arial";ctx.fillStyle="#000"}}class Balls{constructor(s){this.balls=range(s.ballCount).map(i=>new Ball(2,s.ballPos.x,s.ballPos.y));this.onBallStop=b=>{!s.firstBallStop&&(s.ballPos=b.position.copy(),s.firstBallStop=!0);b.position.x=s.ballPos.x};this.balls.forEach(b=>b.setOnStop(this.onBallStop))}collideWithBricks(br){br.bricks.forEach(b=>{this.balls.forEach(ball=>{ball.collideWith(b)&&b.hit()})})}collideWithBonusBall(bb){this.balls.forEach(b=>{bb.forEach(bb=>{b.collideWithBonusBall(bb)&&bb.hitWithBall()})})}get allStopped(){return this.balls.every(b=>b.velocity.mag()===0)}addBalls(s,n){const nb=range(n).map(i=>new Ball(2,s.ballPos.x,s.ballPos.y));nb.forEach(b=>b.setOnStop(this.onBallStop));this.balls.push(...nb)}async shoot(p,s){for(const b of this.balls){if(s.ballDowning)return;b.shoot(p);await delay(Math.max(50-~~(s.ballCount/10),10))}}display(){this.balls.forEach(b=>{b.update();b.checkEdges();b.display()})}down(){this.balls.forEach(b=>b.down())}}class Bricks{constructor(){this.bricks=[];this.particleSystems=new BrickParticleSystems()}addBricks(s,idx){this.bricks.push(...idx.map(i=>new Brick(s.level,i,0)))}display(s){this.bricks.forEach(b=>{b.update(s);b.display(s)});this.particleSystems.run()}break(){const broken=this.bricks.filter(b=>b.broken);this.particleSystems.addParticleSystem(...broken);this.bricks=this.bricks.filter(b=>!b.broken)}shouldSlideDown(s){return this.bricks[0]&&this.bricks[0].shouldMoveDown(s)}get hitBottom(){return this.bricks[0]&&this.bricks[0].hitBottom}}class BonusBalls{constructor(){this.balls=[]}addBonusBalls(s,idx){this.balls=[...this.balls,new BonusBall(s.level,idx,0)]}display(s){this.balls.forEach(b=>{b.update(s);b.display()})}collideWithBall(bs){this.balls.forEach(b=>bs.balls.forEach(ball=>b.collideWith(ball)))}removeHitBalls(){this.balls=this.balls.filter(b=>!b.hit||b.y>height)}get hitBallCount(){return this.balls.filter(b=>b.hit).length}}class LocalStorageManager{constructor(){this.key="brickBestScore";this.storage=window.localStorage}getBestScore(){return this.storage.getItem(this.key)||1}setBestScore(v){this.storage.setItem(this.key,v)}setScore(v){this.setBestScore(Math.max(v,this.getBestScore()))}}let gameManager;function initGame(){class GameManager{constructor(){this.state={ballPos:new Vector(width/2,height-100),ballMoving:!1,ballCount:1+extraBalls,ballDowning:!1,brickMoving:!1,firstBallStop:!0,level:1,over:!1};this.balls=new Balls(this.state);this.bricks=new Bricks();this.bonusBalls=new BonusBalls();this.ballLine={display:s=>{!s.ballMoving&&!s.brickMoving&&s.ballPos&&ctx.setLineDash([5,15]),ctx.beginPath(),ctx.moveTo(s.ballPos.x,s.ballPos.y),ctx.lineTo(Mouse.position.x,Math.min(Mouse.position.y,720)),ctx.stroke(),ctx.setLineDash([])}};this.ui=new UI();this.scoreStorage=new LocalStorageManager();this.state.bestLevel=this.scoreStorage.getBestScore();this.addBallsAndBricks();canvas.addEventListener("click",e=>this.shootBalls(e));canvas.addEventListener("touchstart",e=>{e.preventDefault();this.shootBalls(e.touches[0])},{passive:!1})}addBallsAndBricks(){const bonus=this.bonusBalls.hitBallCount,bricks=shuffle(range(6)).slice(0,Math.random()>.9?randomInt(5):randomInt(4)),bonusIdx=shuffle(range(6).filter(i=>!bricks.includes(i)))[0];this.state.ballCount+=bonus;this.balls.addBalls(this.state,bonus);this.bricks.addBricks(this.state,bricks);this.bonusBalls.addBonusBalls(this.state,bonusIdx)}shootBalls(e){if(this.state.ballMoving||this.state.brickMoving||this.state.over)return;this.state.ballPos=null;this.state.ballMoving=!0;this.state.ballDowning=!1;this.state.firstBallStop=!1;const r=canvas.getBoundingClientRect(),sx=width/r.width,sy=height/r.height,x=(e.clientX||e.touches[0].clientX)-r.left,y=(e.clientY||e.touches[0].clientY)-r.top;Mouse.position.x=x*sx;Mouse.position.y=Math.min(y*sy,720);this.balls.shoot(Mouse.position,this.state)}checkCollision(){this.balls.collideWithBricks(this.bricks);this.bonusBalls.collideWithBall(this.balls);this.bricks.break()}draw(){clear();this.ballLine.display(this.state);this.balls.display();this.bricks.display(this.state);this.bonusBalls.display(this.state);this.ui.display(this.state);this.bricks.hitBottom&&this.ui.gameOver()}run(){this.draw();this.checkCollision();if(this.state.ballMoving&&this.balls.allStopped){this.state.ballMoving=!1;this.state.brickMoving=!0;this.state.level+=1;this.scoreStorage.setScore(this.state.level);this.state.bestLevel=this.scoreStorage.getBestScore();this.addBallsAndBricks()}if(this.state.brickMoving&&!this.bricks.shouldSlideDown(this.state)){this.state.brickMoving=!1;this.bonusBalls.removeHitBalls()}if(this.bricks.hitBottom)this.state.over=!0;requestAnimationFrame(()=>this.run())}downBalls(){this.state.ballDowning=!0;this.balls.down()}}gameManager=new GameManager();gameManager.run();canvas.addEventListener("mousemove",e=>{const r=e.target.getBoundingClientRect();Mouse.position.x=(e.clientX-r.left)*(width/r.width);Mouse.position.y=(e.clientY-r.top)*(height/r.height)});canvas.addEventListener("touchmove",e=>{e.preventDefault();const r=e.target.getBoundingClientRect(),t=e.touches[0];Mouse.position.x=(t.clientX-r.left)*(width/r.width);Mouse.position.y=(t.clientY-r.top)*(height/r.height)},{passive:!1})}document.getElementById('connectBtn').addEventListener('click',initializeWeb3)});
  </script>
</body>
</html>
